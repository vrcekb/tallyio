name: TallyIO Dependency Management

on:
  schedule:
    # Run every Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  push:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # DEPENDENCY AUDIT
  # ============================================================================
  dependency-audit:
    name: ðŸ” Dependency Security Audit
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: ðŸ“¦ Cache Cargo Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ðŸ”’ Install Cargo Audit
      run: cargo install cargo-audit

    - name: ðŸ“¦ Install jq for JSON parsing
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: ðŸ” Run Security Audit
      run: cargo audit --json > audit-report.json
      continue-on-error: true
      
    - name: ðŸ“Š Parse Audit Results
      run: |
        if [ -f audit-report.json ]; then
          # Check if vulnerabilities were found
          VULN_COUNT=$(jq -r '.vulnerabilities.count // 0' audit-report.json)
          VULN_FOUND=$(jq -r '.vulnerabilities.found // false' audit-report.json)

          if [ "$VULN_FOUND" = "true" ] || [ "$VULN_COUNT" -gt 0 ]; then
            echo "ðŸš¨ Security vulnerabilities found!"
            cat audit-report.json
            exit 1
          else
            echo "âœ… No security vulnerabilities found"
            echo "ðŸ“Š Audit report:"
            jq -r '.vulnerabilities' audit-report.json
          fi
        else
          echo "âŒ Audit report not found"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload Audit Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-audit-report
        path: audit-report.json
        retention-days: 30

  # ============================================================================
  # DEPENDENCY UPDATES
  # ============================================================================
  dependency-update:
    name: ðŸ“¦ Dependency Updates
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs: dependency-audit
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ¦€ Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: ðŸ“¦ Install Cargo Edit
      run: cargo install cargo-edit
      
    - name: ðŸ”„ Update Dependencies
      run: |
        echo "ðŸ“¦ Updating dependencies..."
        cargo update --verbose
        
    - name: ðŸ§ª Test Updated Dependencies
      run: |
        echo "ðŸ§ª Testing with updated dependencies..."
        cargo test --workspace --verbose
        
    - name: ðŸ” Run Clippy with Updates
      run: |
        echo "ðŸ” Running clippy with updated dependencies..."
        cargo clippy --workspace -- -D warnings
        
    - name: ðŸ“ Generate Update Report
      run: |
        echo "ðŸ“ Generating dependency update report..."
        git diff --name-only > changed-files.txt
        if [ -s changed-files.txt ]; then
          echo "ðŸ“¦ Dependencies updated:"
          cat changed-files.txt
          
          echo "## Dependency Update Report" > update-report.md
          echo "" >> update-report.md
          echo "### Changed Files:" >> update-report.md
          cat changed-files.txt >> update-report.md
          echo "" >> update-report.md
          echo "### Cargo.lock Changes:" >> update-report.md
          echo '```diff' >> update-report.md
          git diff Cargo.lock >> update-report.md
          echo '```' >> update-report.md
        else
          echo "âœ… No dependency updates needed"
        fi
        
    - name: ðŸ”„ Create Pull Request
      if: success()
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ðŸ“¦ Update dependencies"
        title: "ðŸ“¦ Automated Dependency Updates"
        body-path: update-report.md
        branch: dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated

  # ============================================================================
  # DEPENDENCY VULNERABILITY SCAN
  # ============================================================================
  vulnerability-scan:
    name: ðŸ›¡ï¸ Vulnerability Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: ðŸ”’ Install Cargo Deny
      run: cargo install cargo-deny
      
    - name: ðŸ›¡ï¸ Run Vulnerability Scan
      run: |
        echo "ðŸ›¡ï¸ Scanning for vulnerabilities..."
        cargo deny check advisories --format json > vulnerability-report.json
        
    - name: ðŸ“Š Process Vulnerability Report
      run: |
        if [ -s vulnerability-report.json ]; then
          echo "ðŸš¨ Vulnerabilities detected!"
          cat vulnerability-report.json
          
          # Create GitHub issue for vulnerabilities
          echo "Creating GitHub issue for vulnerabilities..."
        else
          echo "âœ… No vulnerabilities found"
        fi
        
    - name: ðŸ“¤ Upload Vulnerability Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-report
        path: vulnerability-report.json
        retention-days: 30

  # ============================================================================
  # LICENSE COMPLIANCE CHECK
  # ============================================================================
  license-check:
    name: âš–ï¸ License Compliance
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ¦€ Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: ðŸ”’ Install Cargo Deny
      run: cargo install cargo-deny
      
    - name: âš–ï¸ Check License Compliance
      run: |
        echo "âš–ï¸ Checking license compliance..."
        cargo deny check licenses --format json > license-report.json
        
    - name: ðŸ“Š Process License Report
      run: |
        if [ -s license-report.json ]; then
          echo "ðŸ“‹ License compliance report:"
          cat license-report.json
        else
          echo "âœ… All licenses compliant"
        fi
        
    - name: ðŸ“¤ Upload License Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-report
        path: license-report.json
        retention-days: 30

  # ============================================================================
  # DEPENDENCY SUMMARY
  # ============================================================================
  dependency-summary:
    name: ðŸ“‹ Dependency Summary
    runs-on: ubuntu-22.04
    needs: [dependency-audit, vulnerability-scan, license-check]
    if: always()
    timeout-minutes: 10
    
    steps:
    - name: ðŸ“¥ Download All Reports
      uses: actions/download-artifact@v4
      
    - name: ðŸ“‹ Generate Summary Report
      run: |
        echo "# TallyIO Dependency Management Summary" > summary.md
        echo "" >> summary.md
        echo "## ðŸ” Security Audit" >> summary.md
        if [ -f security-audit-report/audit-report.json ]; then
          echo "âœ… Security audit completed" >> summary.md
        else
          echo "âŒ Security audit failed" >> summary.md
        fi
        echo "" >> summary.md
        
        echo "## ðŸ›¡ï¸ Vulnerability Scan" >> summary.md
        if [ -f vulnerability-report/vulnerability-report.json ]; then
          echo "âœ… Vulnerability scan completed" >> summary.md
        else
          echo "âŒ Vulnerability scan failed" >> summary.md
        fi
        echo "" >> summary.md
        
        echo "## âš–ï¸ License Compliance" >> summary.md
        if [ -f license-report/license-report.json ]; then
          echo "âœ… License compliance checked" >> summary.md
        else
          echo "âŒ License compliance check failed" >> summary.md
        fi
        echo "" >> summary.md
        
        echo "## ðŸŽ¯ TallyIO Status" >> summary.md
        echo "ðŸš€ Ready for ultra-performance MEV operations!" >> summary.md
        
        cat summary.md
        
    - name: ðŸ“¤ Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: dependency-summary
        path: summary.md
        retention-days: 30
